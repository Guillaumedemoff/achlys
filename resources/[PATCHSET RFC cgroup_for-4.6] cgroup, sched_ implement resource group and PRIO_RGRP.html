<!DOCTYPE html>
<!-- saved from url=(0073)https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099161.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>[PATCHSET RFC cgroup/for-4.6] cgroup, sched: implement resource group and PRIO_RGRP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="https://www.mail-archive.com/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://www.mail-archive.com/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="https://www.mail-archive.com/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="https://www.mail-archive.com/favicon.ico">
<link rel="contents" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/thrd11.html#1099161" id="c">
<link rel="index" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/mail12.html#1099161" id="i">
<link rel="prev" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099160.html" id="p">
<link rel="next" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099162.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099161.html">
<link rel="stylesheet" href="./[PATCHSET RFC cgroup_for-4.6] cgroup, sched_ implement resource group and PRIO_RGRP_files/normalize.css" media="screen">
<link rel="stylesheet" href="./[PATCHSET RFC cgroup_for-4.6] cgroup, sched_ implement resource group and PRIO_RGRP_files/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope="" itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099161.html#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="https://www.mail-archive.com/search?l=linux-kernel@vger.kernel.org&amp;q=subject:%22%5C%5BPATCHSET+RFC+cgroup%5C%2Ffor%5C-4.6%5C%5D+cgroup%2C+sched%5C%3A+implement+resource+group+and+PRIO_RGRP%22&amp;o=newest" rel="nofollow"><span itemprop="name">[PATCHSET RFC cgroup/for-4.6] cgroup, sched: implement resource group and PRIO_RGRP</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="https://www.mail-archive.com/search?l=linux-kernel@vger.kernel.org&amp;q=from:%22Tejun+Heo%22" rel="nofollow"><span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span itemprop="name">Tejun Heo</span></span></a></span>
<span class="date"><a href="https://www.mail-archive.com/search?l=linux-kernel@vger.kernel.org&amp;q=date:20160311" rel="nofollow">Fri, 11 Mar 2016 07:43:05 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hello,

This patchset extends cgroup v2 to support rgroup (resource group) for
in-process hierarchical resource control and implements PRIO_RGRP for
setpriority(2) on top to allow in-process hierarchical CPU cycle
control in a seamless way.</pre><pre>
cgroup v1 allowed putting threads of a process in different cgroups
which enabled ad-hoc in-process resource control of some resources.
Unfortunately, this approach was fraught with problems such as
membership ambiguity with per-process resources and lack of isolation
between system management and in-process properties.  For a more
detailed discussion on the subject, please refer to the following
message.

 [1] [RFD] cgroup: thread granularity support for cpu controller

This patchset implements the mechanism outlined in the above message.
The new mechanism is named rgroup (resource group).  When explicitly
designating a non-rgroup cgroup, the term sgroup (system group) is
used.  rgroup has the following properties.

* A rgroup is a cgroup which is invisible on and transparent to the
  system-level cgroupfs interface.

* A rgroup can be created by specifying CLONE_NEWRGRP flag, along with
  CLONE_THREAD, during clone(2).  A new rgroup is created under the
  parent thread's cgroup and the new thread is created in it.

* A rgroup is automatically destroyed when empty.

* A top-level rgroup of a process is a rgroup whose parent cgroup is a
  sgroup.  A process may have multiple top-level rgroups and thus
  multiple rgroup subtrees under the same parent sgroup.

* Unlike sgroups, rgroups are allowed to compete against peer threads.
  Each rgroup behaves equivalent to a sibling task.

* rgroup subtrees are local to the process.  When the process forks or
  execs, its rgroup subtrees are collapsed.

* When a process is migrated to a different cgroup, its rgroup
  subtrees are preserved.

* Subset of controllers available on the parent sgroup are available
  to rgroup subtrees.  Controller management on rgroups is automatic
  and implicit and doesn't interfere with system-level cgroup
  controller management.  If a controller is made unavailable on the
  parent sgroup, it's automatically disabled from child rgroup
  subtrees.

rgroup lays the foundation for other kernel mechanisms to make use of
resource controllers while providing proper isolation between system
management and in-process operations removing the awkward and
layer-violating requirement for coordination between individual
applications and system management.  On top of the rgroup mechanism,
PRIO_RGRP is implemented for {set|get}priority(2).

* PRIO_RGRP can only be used if the target task is already in a
  rgroup.  If setpriority(2) is used and cpu controller is available,
  cpu controller is enabled until the target rgroup is covered and the
  specified nice value is set as the weight of the rgroup.

* The specified nice value has the same meaning as for tasks.  For
  example, a rgroup and a task competing under the same parent would
  behave exactly the same as two tasks.

* For top-level rgroups, PRIO_RGRP follows the same rlimit
  restrictions as PRIO_PROCESS; however, as nested rgroups only
  distribute CPU cycles which are allocated to the process, no
  restriction is applied.

PRIO_RGRP allows in-process hierarchical control of CPU cycles in a
manner which is a straight-forward and minimal extension of existing
task and priority management.

There are still some missing pieces.

* Documentation updates.

* A mechanism that applications can use to publish certain rgroups so
  that external entities can determine which IDs to use to change
  rgroup settings.  I already have interface and implementation design
  mostly pinned down.

* Userland updates such as integrating CLONE_NEWRGRP handling to
  pthread or updating renice(1) to handle resource groups.

I'll attach a test program which demonstrates PRIO_RGRP usage in a
follow up email.

This patchset contains the following 10 patches.

 0001-cgroup-introduce-cgroup_-un-lock.patch
 0002-cgroup-un-inline-cgroup_path-and-friends.patch
 0003-cgroup-introduce-CGRP_MIGRATE_-flags.patch
 0004-signal-make-put_signal_struct-public.patch
 0005-cgroup-fork-add-new_rgrp_cset-p-and-clone_flags-to-c.patch
 0006-cgroup-fork-add-child-and-clone_flags-to-threadgroup.patch
 0007-cgroup-introduce-resource-group.patch
 0008-cgroup-implement-rgroup-control-mask-handling.patch
 0009-cgroup-implement-rgroup-subtree-migration.patch
 0010-cgroup-sched-implement-PRIO_RGRP-for-set-get-priorit.patch

0001-0006 are prepatory patches.
0007-0009 implemnet rgroup support.
0010 implements PRIO_RGRP.

This patchset is on top of

  cgroup/for-4.6 f6d635ad341d ("cgroup: implement 
cgroup_subsys-&gt;implicit_on_dfl")
+ [2] [PATCH 2/2] cgroup, perf_event: make perf_event controller work on 
cgroup2 hierarchy
+ [3] [PATCHSET REPOST] sched, cgroup: implement cgroup v2 interface for cpu 
controller

and available in the following git branch.

 git://git.kernel.org/pub/scm/linux/kernel/git/tj/cgroup.git 
review-cgroup2-rgroup

diffstat follows.

 fs/exec.c                     |    8 
 include/linux/cgroup-defs.h   |   72 ++-
 include/linux/cgroup.h        |   60 +--
 include/linux/sched.h         |   31 +
 include/uapi/linux/resource.h |    1 
 include/uapi/linux/sched.h    |    1 
 kernel/cgroup.c               |  828 ++++++++++++++++++++++++++++++++++++++----
 kernel/fork.c                 |   27 -
 kernel/sched/core.c           |   32 +
 kernel/signal.c               |    6 
 kernel/sys.c                  |   11 
 11 files changed, 917 insertions(+), 160 deletions(-)

Thanks.

--
tejun

[1] <a rel="nofollow" href="http://lkml.kernel.org/g/20160105154503.gc5...@mtj.duckdns.org">http://lkml.kernel.org/g/20160105154503.gc5...@mtj.duckdns.org</a>
[2] <a rel="nofollow" href="http://lkml.kernel.org/g/1456351975-1899-3-git-send-email...@kernel.org">http://lkml.kernel.org/g/1456351975-1899-3-git-send-email...@kernel.org</a>
[3] <a rel="nofollow" href="http://lkml.kernel.org/g/20160105164758.gd5...@mtj.duckdns.org">http://lkml.kernel.org/g/20160105164758.gd5...@mtj.duckdns.org</a>

</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099160.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/thrd11.html#1099161">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/mail12.html#1099161">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099162.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">[PATCHSET RFC cgroup/for-4.6] cgroup, sched: implement resource ...</span> <span class="sender italic">Tejun Heo</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099162.html">[PATCH 08/10] cgroup: implement rgroup control mask handlin...</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099164.html">[PATCH 04/10] signal: make put_signal_struct() public</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099165.html">[PATCH 02/10] cgroup: un-inline cgroup_path() and friends</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099166.html">[PATCH 07/10] cgroup: introduce resource group</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099168.html">[PATCH 10/10] cgroup, sched: implement PRIO_RGRP for {set|g...</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099169.html">[PATCH 09/10] cgroup: implement rgroup subtree migration</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099171.html">[PATCH 06/10] cgroup, fork: add @child and @clone_flags to ...</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099172.html">[PATCH 03/10] cgroup: introduce CGRP_MIGRATE_* flags</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099177.html">[PATCH 01/10] cgroup: introduce cgroup_[un]lock()</a></span> <span class="sender italic">Tejun Heo</span></li>
<li class="icons-email"><span class="subject"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099180.html">[PATCH 05/10] cgroup, fork: add @new_rgrp_cset[p] and @clon...</a></span> <span class="sender italic">Tejun Heo</span></li>
</ul>
</li></ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply">
<h2>
					Reply via email to
</h2>
<form method="POST" action="https://www.mail-archive.com/mailto.php">
<input type="hidden" name="subject" value="[PATCHSET RFC cgroup/for-4.6] cgroup, sched: implement resource group and PRIO_RGRP">
<input type="hidden" name="msgid" value="1457710888-31182-1-git-send-email-tj@kernel.org">
<input type="hidden" name="relpath" value="linux-kernel@vger.kernel.org/msg1099161.html">
<input type="submit" value=" Tejun Heo ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="https://www.mail-archive.com/"><img src="./[PATCHSET RFC cgroup_for-4.6] cgroup, sched_ implement resource group and PRIO_RGRP_files/logo.png" width="247" height="88" alt="The Mail Archive"></a>
</div>
<form class="overflow" action="https://www.mail-archive.com/search" method="get">
<input type="hidden" name="l" value="linux-kernel@vger.kernel.org">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search linux-kernel">
<input class="submitbutton" name="submit" type="image" src="./[PATCHSET RFC cgroup_for-4.6] cgroup, sched_ implement resource group and PRIO_RGRP_files/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="https://www.mail-archive.com/">The Mail Archive home</a></li>
<li class="icons-list"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/">linux-kernel - all messages</a></li>
<li class="icons-about"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/info.html">linux-kernel - about the list</a></li>
<li class="icons-expand"><a href="https://www.mail-archive.com/search?l=linux-kernel@vger.kernel.org&amp;q=subject:%22%5C%5BPATCHSET+RFC+cgroup%5C%2Ffor%5C-4.6%5C%5D+cgroup%2C+sched%5C%3A+implement+resource+group+and+PRIO_RGRP%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099160.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099162.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">
<a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1099161.html#"><img src="./[PATCHSET RFC cgroup_for-4.6] cgroup, sched_ implement resource group and PRIO_RGRP_files/logo(1).png" alt="linux-kernel"></a>
</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="https://www.mail-archive.com/">The Mail Archive home</a></li>
<li><a href="https://www.mail-archive.com/faq.html#newlist">Add your mailing list</a></li>
<li><a href="https://www.mail-archive.com/faq.html">FAQ</a></li>
<li><a href="https://www.mail-archive.com/faq.html#support">Support</a></li>
<li><a href="https://www.mail-archive.com/faq.html#privacy">Privacy</a></li>
<li class="darkgray">1457710888-31182-1-git-send-email-tj@kernel.org</li>
</ul>
</div>


</body></html>